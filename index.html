<!DOCTYPE html>
<html lang="en">
<head>
<title>Yakin Search ‚Äì Doƒüu AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">

<style>
:root{
  --bg:#0b0e14;
  --card:#111827;
  --border:#374151;
  --text:#e8eaed;
  --link:#8ab4f8;
  --url:#34d399;
  --muted:#9ca3af;
  --accent:#8b5cf6;
  --hotword:#10b981;
  --recording:#ef4444;
}
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
}
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;
  background:var(--bg);
  color:var(--text);
  line-height:1.5;
  min-height:100vh;
}

/* Top Left Logo - Fixed Position */
.top-logo{
  position:fixed;
  top:20px;
  left:20px;
  width:40px;
  height:40px;
  object-fit:contain;
  cursor:pointer;
  z-index:1000;
  transition:all 0.3s ease;
  border-radius:8px;
  background:var(--card);
  padding:4px;
  border:1px solid var(--border);
}
.top-logo:hover{
  transform:scale(1.05);
  opacity:0.9;
  border-color:var(--accent);
}

  /* Hide logo completely in search mode on desktop */
@media(min-width:769px){
  header.top-mode ~ .top-logo{
    display: none;
  }
}

header{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  padding:20px;
  transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position:relative;
}
header.top-mode{
  min-height:auto;
  flex-direction:row;
  justify-content:flex-start;
  padding:16px 24px;
  border-bottom:1px solid var(--border);
  position:sticky;
  top:0;
  background:var(--bg);
  z-index:100;
  gap:16px;
}

.yakin-logo{
  font-size:4rem;
  font-weight:600;
  margin-bottom:32px;
  display:flex;
  align-items:center;
  gap:16px;
  transition:all 0.4s ease;
  text-align:center;
}
header.top-mode .yakin-logo{
  font-size:1.5rem;
  margin-bottom:0;
  margin-right:8px;
}

.search-container{
  width:100%;
  max-width:584px;
  position:relative;
  transition:all 0.4s ease;
}
header.top-mode .search-container{
  max-width:692px;
}

.search-box{
  position:relative;
  width:100%;
  display:flex;
  align-items:center;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:24px;
  padding:8px 16px;
  box-shadow:0 1px 6px rgba(0,0,0,0.3);
  transition:all 0.2s ease;
}
.search-box:hover,
.search-box:focus-within{
  background:#1f2937;
  box-shadow:0 2px 8px rgba(139,92,246,0.15);
  border-color:var(--accent);
}

.search-input{
  flex:1;
  background:transparent;
  border:none;
  color:var(--text);
  font-size:16px;
  padding:8px 32px 8px 12px;
  outline:none;
  width:100%;
}
.search-input::placeholder{
  color:var(--muted);
}

.clear-btn{
  position:absolute;
  right:140px;
  background:rgba(255,255,255,0.1);
  border:none;
  color:var(--muted);
  width:24px;
  height:24px;
  border-radius:50%;
  cursor:pointer;
  display:none;
  align-items:center;
  justify-content:center;
  font-size:14px;
  transition:all 0.2s;
  z-index:10;
}
.clear-btn:hover{
  background:rgba(255,255,255,0.2);
  color:var(--text);
}
.clear-btn.visible{
  display:flex;
}
header.top-mode .clear-btn{
  right:140px;
}

.search-btns{
  display:flex;
  gap:8px;
  align-items:center;
  margin-left:8px;
  border-left:1px solid var(--border);
  padding-left:8px;
}

.icon-btn{
  background:none;
  border:none;
  color:var(--muted);
  cursor:pointer;
  font-size:1.2rem;
  padding:6px;
  border-radius:50%;
  transition:all 0.2s;
  display:flex;
  align-items:center;
  justify-content:center;
  width:36px;
  height:36px;
  position:relative;
}
.icon-btn:hover{
  background:rgba(139,92,246,0.1);
  color:var(--text);
  transform:scale(1.05);
}
.icon-btn.hotword-active{
  color:var(--hotword);
  background:rgba(16,185,129,0.15);
  animation:pulse-border 2s infinite;
}
.icon-btn.recording{
  color:var(--recording);
  background:rgba(239,68,68,0.15);
  animation:pulse-recording 1s infinite;
}
@keyframes pulse-border{
  0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,0.4);}
  50%{box-shadow:0 0 0 8px rgba(16,185,129,0);}
}
@keyframes pulse-recording{
  0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4);}
  50%{box-shadow:0 0 0 8px rgba(239,68,68,0);}
}

.hotword-badge{
  position:absolute;
  top:-8px;
  right:-8px;
  background:var(--hotword);
  color:var(--bg);
  font-size:0.65rem;
  padding:2px 6px;
  border-radius:10px;
  font-weight:bold;
  display:none;
}
.icon-btn.hotword-active .hotword-badge{
  display:block;
}

.action-buttons{
  display:flex;
  gap:12px;
  margin-top:24px;
  justify-content:center;
  opacity:1;
  transition:opacity 0.3s;
}
header.top-mode .action-buttons{
  display:none;
}
.action-btn{
  background:var(--card);
  border:1px solid var(--border);
  color:var(--text);
  padding:10px 24px;
  border-radius:4px;
  cursor:pointer;
  font-size:14px;
  transition:all 0.2s;
}
.action-btn:hover{
  border-color:var(--accent);
  background:#1f2937;
  box-shadow:0 1px 2px rgba(0,0,0,0.2);
}

.tabs{
  display:none;
  gap:8px;
  padding:12px 24px;
  border-bottom:1px solid var(--border);
  background:var(--bg);
  position:sticky;
  top:73px;
  z-index:99;
}
.tabs.visible{
  display:flex;
}
.tab{
  padding:8px 16px;
  cursor:pointer;
  color:var(--muted);
  font-size:14px;
  border-radius:4px;
  transition:all 0.2s;
  position:relative;
}
.tab:hover{
  color:var(--text);
  background:rgba(139,92,246,0.1);
}
.tab.active{
  color:var(--accent);
  background:rgba(139,92,246,0.15);
}
.tab.active::after{
  content:'';
  position:absolute;
  bottom:-12px;
  left:0;
  right:0;
  height:2px;
  background:var(--accent);
}

#results{
  max-width:800px;
  margin:24px auto;
  padding:0 24px;
  min-height:50vh;
}

.result-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:18px 20px;
  margin-bottom:16px;
  transition:transform 0.2s,background 0.2s;
}
.result-card:hover{
  background:#1a2332;
  transform:translateY(-1px);
  border-color:#4b5563;
}
.result-title{
  font-size:1.1rem;
  color:var(--link);
  text-decoration:none;
  display:block;
  margin-bottom:6px;
  font-weight:500;
}
.result-title:hover{
  text-decoration:underline;
}
.result-title:visited{
  color:#c58af9;
}
.result-url{
  color:var(--url);
  font-size:0.9rem;
  margin-bottom:8px;
  display:flex;
  align-items:center;
  gap:8px;
}
.result-favicon{
  width:16px;
  height:16px;
  border-radius:2px;
}
.result-snippet{
  color:var(--muted);
  font-size:0.95rem;
  line-height:1.6;
}

.dogu-ai-header{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:12px;
}
.dogu-ai-icon{
  width:28px;
  height:28px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:0.9rem;
  box-shadow:0 2px 8px rgba(102,126,234,0.3);
}
.note{
  color:var(--muted);
  font-size:0.85rem;
  margin-top:8px;
  line-height:1.4;
}

.voice-status{
  position:fixed;
  top:24px;
  right:24px;
  background:var(--card);
  padding:12px 20px;
  border-radius:24px;
  display:none;
  align-items:center;
  gap:12px;
  box-shadow:0 4px 20px rgba(0,0,0,0.5);
  z-index:10000;
  border:1px solid var(--border);
  animation:slideIn 0.3s ease;
  min-width:260px;
}
.voice-status.hotword-mode{
  border-color:var(--hotword);
}
.voice-status.recording-mode{
  border-color:var(--recording);
}
@keyframes slideIn{
  from{transform:translateX(100px);opacity:0;}
  to{transform:translateX(0);opacity:1;}
}
.voice-dot{
  width:10px;
  height:10px;
  background:var(--hotword);
  border-radius:50%;
  animation:pulse-hotword 2s infinite;
  flex-shrink:0;
}
.voice-dot.recording{
  background:var(--recording);
  animation:pulse-recording 1s infinite;
}
@keyframes pulse-hotword{
  0%,100%{transform:scale(1);opacity:1;}
  50%{transform:scale(1.2);opacity:0.7;}
}
.voice-text{
  font-size:0.9rem;
  font-weight:500;
  flex:1;
}
.countdown{
  font-family:monospace;
  font-size:0.85rem;
  color:var(--recording);
  margin-left:8px;
}

.loading-spinner{
  border:3px solid #1f2937;
  border-top:3px solid var(--accent);
  border-radius:50%;
  width:40px;
  height:40px;
  animation:spin 1s linear infinite;
  margin:60px auto;
}
@keyframes spin{
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}

.pagination{
  display:flex;
  gap:16px;
  justify-content:center;
  align-items:center;
  margin:40px 0;
}
.page-btn{
  padding:10px 20px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  border-radius:8px;
  cursor:pointer;
  font-size:0.9rem;
  transition:all 0.2s;
}
.page-btn:hover:not(:disabled){
  border-color:var(--accent);
  background:rgba(139,92,246,0.1);
}
.page-btn:disabled{
  opacity:0.4;
  cursor:not-allowed;
}

.music-options{
  display:flex;
  gap:12px;
  margin-top:16px;
  flex-wrap:wrap;
}
.music-btn{
  padding:10px 20px;
  background:var(--border);
  border:1px solid transparent;
  border-radius:20px;
  font-size:0.9rem;
  cursor:pointer;
  color:var(--text);
  transition:all 0.2s;
}
.music-btn:hover{
  background:#4b5563;
  border-color:var(--accent);
  transform:translateY(-1px);
}

.history-item{
  padding:10px 14px;
  margin:6px 0;
  background:rgba(139,92,246,0.08);
  border-radius:8px;
  cursor:pointer;
  font-size:0.95rem;
  transition:all 0.2s;
  border-left:3px solid transparent;
}
.history-item:hover{
  background:rgba(139,92,246,0.15);
  border-left-color:var(--accent);
  padding-left:16px;
}

.service-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.8);
  backdrop-filter:blur(4px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
  padding:20px;
  animation:fadeIn 0.2s;
}
@keyframes fadeIn{
  from{opacity:0;}
  to{opacity:1;}
}
.modal-content{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:28px;
  max-width:600px;
  width:100%;
  max-height:85vh;
  overflow-y:auto;
  box-shadow:0 20px 60px rgba(0,0,0,0.5);
}
.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:24px;
}
.modal-close{
  background:none;
  border:none;
  color:var(--muted);
  font-size:1.8rem;
  cursor:pointer;
  width:36px;
  height:36px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:50%;
  transition:all 0.2s;
}
.modal-close:hover{
  background:rgba(255,255,255,0.1);
  color:var(--text);
}
.file-upload-area{
  border:2px dashed var(--border);
  border-radius:12px;
  padding:48px 24px;
  text-align:center;
  cursor:pointer;
  transition:all 0.2s;
  margin-bottom:24px;
}
.file-upload-area:hover,
.file-upload-area.dragover{
  border-color:var(--accent);
  background:rgba(139,92,246,0.05);
}
.upload-icon{
  font-size:3rem;
  margin-bottom:12px;
  opacity:0.8;
}
.file-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 16px;
  background:#1f2937;
  border-radius:8px;
  margin-bottom:8px;
  gap:12px;
  border:1px solid transparent;
  transition:all 0.2s;
}
.file-item:hover{
  border-color:var(--border);
  transform:translateX(4px);
}
.file-name{
  flex:1;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  font-size:0.9rem;
}
.file-size{
  font-size:0.8rem;
  color:var(--muted);
  font-variant-numeric:tabular-nums;
}
.file-action-btn{
  background:none;
  border:none;
  color:var(--muted);
  cursor:pointer;
  font-size:1.1rem;
  padding:4px 8px;
  border-radius:4px;
  transition:all 0.2s;
}
.file-action-btn:hover{
  color:var(--accent);
  background:rgba(139,92,246,0.1);
}
.file-services{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:12px;
  margin-top:20px;
}
.file-service{
  background:#1f2937;
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px 12px;
  text-align:center;
  cursor:pointer;
  transition:all 0.2s;
}
.file-service:hover{
  background:#374151;
  transform:translateY(-2px);
  border-color:var(--accent);
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
}
.file-service-icon{
  font-size:2rem;
  margin-bottom:8px;
}
.file-service-name{
  font-size:0.95rem;
  font-weight:600;
  margin-bottom:4px;
}
.file-service-desc{
  font-size:0.8rem;
  color:var(--muted);
}
.welcome-hint{
  color:var(--muted);
  font-size:0.9rem;
  margin-top:24px;
  text-align:center;
  max-width:600px;
  line-height:1.6;
}
.welcome-hint kbd{
  background:var(--card);
  padding:2px 8px;
  border-radius:4px;
  border:1px solid var(--border);
  font-family:monospace;
  font-size:0.85em;
}

/* Mobile responsiveness */
@media(max-width:768px){
  .top-logo{
    width:40px;
    height:40px;
    top:12px;
    left:12px;
  }
  header.top-mode ~ .top-logo{
    display:none;
  }
  .yakin-logo{font-size:2.5rem;}
  header.top-mode{padding:12px 16px;gap:12px;}
  header.top-mode .yakin-logo{font-size:1.2rem;}
  .search-container{max-width:100%;}
  .clear-btn{right:130px;}
  header.top-mode .clear-btn{right:130px;}
  #results{padding:0 16px;margin:16px auto;}
  .file-services{grid-template-columns:repeat(2,1fr);}
  .action-buttons{flex-direction:column;width:100%;padding:0 20px;}
  .action-btn{width:100%;}
  .voice-status{top:auto;bottom:24px;right:16px;left:16px;justify-content:center;min-width:auto;}
}
</style>
</head>
<body>

<!-- Top Left Logo - Click to reset -->
<img id="topLogo" class="top-logo" src="logo.jpg" alt="Yakin Search" title="Click to reset search">

<header id="mainHeader">
  <div class="yakin-logo">üöÄYakin Search</div>
  
  <div class="search-container">
    <div class="search-box">
      <input id="searchInput" class="search-input" placeholder="Search the web..." autocomplete="off">
      
      <button class="clear-btn" id="clearBtn" title="Clear">‚úï</button>
      
      <div class="search-btns">
        <button class="icon-btn" id="voiceBtn" title="Voice commands (Search/Open/Play/Clear)">
          üé§
          <span class="hotword-badge">ON</span>
        </button>
        <button class="icon-btn" id="fileBtn" title="File Search">üìÅ</button>
        <button class="icon-btn" id="textSearchBtn" title="Search" style="background:var(--accent);color:white;">üîç</button>
      </div>
    </div>
  </div>
  
  <div class="action-buttons">
    <button class="action-btn" onclick="handleSearch(elements.input.value)">Yakin Search</button>
    <button class="action-btn" onclick="handleSearch(elements.input.value)">I'm hopeful</button>
  </div>
  
  <div class="welcome-hint" id="welcomeHint">
    Click üé§ to activate voice ‚Ä¢ Always listening when ON<br>
    <small style="opacity:0.7">Say: "Search...", "Open...", "Play...", or "Clear" ‚Ä¢ You have 10 seconds after wake word</small>
  </div>
</header>

<div class="tabs" id="tabs">
  <div class="tab active" data-type="web">üîç All</div>
</div>

<div class="voice-status" id="voiceStatus">
  <div class="voice-dot" id="voiceDot"></div>
  <div class="voice-text" id="voiceText">Listening...</div>
  <span class="countdown" id="countdown"></span>
</div>

<div id="results"></div>

<div class="service-modal" id="fileModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0;font-size:1.3rem">File Services</h3>
      <button class="modal-close" onclick="closeFileModal()">√ó</button>
    </div>
    
    <div class="file-upload-area" id="uploadArea">
      <div class="upload-icon">üìÅ</div>
      <p style="font-size:1.1rem;margin-bottom:8px">Drag & drop files here</p>
      <p class="note">or click to browse ‚Ä¢ Supports images, documents, audio, video</p>
      <input type="file" id="fileInput" multiple style="display:none">
    </div>
    
    <div id="fileList"></div>
    
    <div style="margin-top:24px;margin-bottom:12px;font-weight:600;color:var(--muted);font-size:0.9rem">SEARCH ON</div>
    <div class="file-services">
      <div class="file-service" onclick="searchOnService('googleDrive')">
        <div class="file-service-icon">üìÅ</div>
        <div class="file-service-name">Google Drive</div>
      </div>
      <div class="file-service" onclick="searchOnService('dropbox')">
        <div class="file-service-icon">üì¶</div>
        <div class="file-service-name">Dropbox</div>
      </div>
      <div class="file-service" onclick="searchOnService('onedrive')">
        <div class="file-service-icon">‚òÅÔ∏è</div>
        <div class="file-service-name">OneDrive</div>
      </div>
      <div class="file-service" onclick="searchOnService('icloud')">
        <div class="file-service-icon">üçé</div>
        <div class="file-service-name">iCloud</div>
      </div>
    </div>
    
    <div style="margin-top:20px;margin-bottom:12px;font-weight:600;color:var(--muted);font-size:0.9rem">QUICK OPEN</div>
    <div class="file-services">
      <div class="file-service" onclick="openService('github')">
        <div class="file-service-icon">üíª</div>
        <div class="file-service-name">GitHub</div>
      </div>
      <div class="file-service" onclick="openService('wetransfer')">
        <div class="file-service-icon">üì§</div>
        <div class="file-service-name">WeTransfer</div>
      </div>
      <div class="file-service" onclick="openService('figma')">
        <div class="file-service-icon">üé®</div>
        <div class="file-service-name">Figma</div>
      </div>
      <div class="file-service" onclick="openService('notion')">
        <div class="file-service-icon">üìù</div>
        <div class="file-service-name">Notion</div>
      </div>
    </div>
  </div>
</div>

<script>
const CONFIG = {
  GOOGLE_API_KEY: '',
  GOOGLE_CX: '',
  YOUTUBE_API_KEY: ''
};

let currentTab = 'web';
let currentPage = 1;
let lastQuery = '';
let isListening = false;
let hotwordEnabled = false;
let recognition = null;
let searchHistory = JSON.parse(localStorage.getItem('yakinHistory')) || [];
let uploadedFiles = JSON.parse(localStorage.getItem('yakinFiles')) || [];

let isWaitingForCommand = false;
let commandTimeout = null;
let countdownInterval = null;
const WAKE_WORDS = ['search', 'open', 'play', 'clear', 'hope'];
const COMMAND_TIMEOUT_MS = 10000;

const elements = {
  input: document.getElementById('searchInput'),
  results: document.getElementById('results'),
  header: document.getElementById('mainHeader'),
  tabs: document.getElementById('tabs'),
  voiceStatus: document.getElementById('voiceStatus'),
  voiceText: document.getElementById('voiceText'),
  voiceDot: document.getElementById('voiceDot'),
  countdown: document.getElementById('countdown'),
  fileModal: document.getElementById('fileModal'),
  uploadArea: document.getElementById('uploadArea'),
  fileInput: document.getElementById('fileInput'),
  fileList: document.getElementById('fileList'),
  voiceBtn: document.getElementById('voiceBtn'),
  fileBtn: document.getElementById('fileBtn'),
  textSearchBtn: document.getElementById('textSearchBtn'),
  welcomeHint: document.getElementById('welcomeHint'),
  clearBtn: document.getElementById('clearBtn'),
  topLogo: document.getElementById('topLogo')
};

function init() {
  elements.input.focus();
  renderHistory();
  initHotwordRecognition();
  
  // Top logo click to reset
  elements.topLogo.addEventListener('click', resetSearch);
  
  elements.input.addEventListener('input', toggleClearButton);
  elements.input.addEventListener('keyup', toggleClearButton);
  
  elements.input.addEventListener('keydown', handleInputKeydown);
  elements.textSearchBtn.addEventListener('click', () => handleSearch(elements.input.value));
  elements.voiceBtn.addEventListener('click', toggleHotwordMode);
  elements.fileBtn.addEventListener('click', openFileModal);
  elements.clearBtn.addEventListener('click', clearSearch);
  
  elements.uploadArea.addEventListener('click', () => elements.fileInput.click());
  elements.uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    elements.uploadArea.classList.add('dragover');
  });
  elements.uploadArea.addEventListener('dragleave', () => {
    elements.uploadArea.classList.remove('dragover');
  });
  elements.uploadArea.addEventListener('drop', handleFileDrop);
  elements.fileInput.addEventListener('change', handleFileSelect);
  
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab.dataset.type));
  });
  
  elements.fileModal.addEventListener('click', (e) => {
    if (e.target === elements.fileModal) closeFileModal();
  });
}

/* ========== RESET SEARCH (Logo Click) ========== */
function resetSearch() {
  // Clear search input
  elements.input.value = '';
  elements.clearBtn.classList.remove('visible');
  
  // THIS LINE shows the logo (removes top-mode class):
  elements.header.classList.remove('top-mode');
  elements.tabs.classList.remove('visible');
  elements.results.innerHTML = '';
  elements.welcomeHint.style.display = 'block';
  elements.welcomeHint.innerHTML = 'Click üé§ to activate voice ‚Ä¢ Always listening when ON<br><small style="opacity:0.7">Say: "Search...", "Open...", "Play...", or "Clear" ‚Ä¢ You have 10 seconds after wake word</small>';
  
  elements.input.focus();
  
  console.log('Search reset via logo click');
}

function toggleClearButton() {
  if (elements.input.value.length > 0) {
    elements.clearBtn.classList.add('visible');
  } else {
    elements.clearBtn.classList.remove('visible');
  }
}

function clearSearch() {
  elements.input.value = '';
  elements.input.focus();
  elements.clearBtn.classList.remove('visible');
  if (hotwordEnabled && !isWaitingForCommand) {
    updateVoiceStatus('Ready for command...');
  }
}

/* ========== PERSISTENT VOICE LISTENING ========== */
function initHotwordRecognition() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    elements.voiceBtn.style.display = 'none';
    return;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';
  
  recognition.onstart = () => {
    isListening = true;
    elements.voiceStatus.style.display = 'flex';
    elements.voiceStatus.classList.add('hotword-mode');
    elements.voiceBtn.classList.add('hotword-active');
    updateVoiceStatus('Always listening...');
    console.log('Voice always-on mode started');
  };
  
  recognition.onresult = (e) => {
    let finalTranscript = '';
    let interimTranscript = '';
    
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const transcript = e.results[i][0].transcript.toLowerCase().trim();
      if (e.results[i].isFinal) {
        finalTranscript += transcript + ' ';
      } else {
        interimTranscript += transcript;
      }
    }
    
    const fullTranscript = (finalTranscript + interimTranscript).trim();
    console.log('Heard:', fullTranscript, '| Waiting:', isWaitingForCommand);
    
    if (isWaitingForCommand) {
      handleCommandInput(fullTranscript, finalTranscript);
      return;
    }
    
    if (fullTranscript.includes('clear') && (fullTranscript.includes('search') || fullTranscript.includes('bar'))) {
      executeCommand('clear', '');
      return;
    }
    
    for (const word of WAKE_WORDS) {
      if (fullTranscript.includes(word)) {
        const index = fullTranscript.indexOf(word);
        const afterWakeWord = fullTranscript.substring(index + word.length).trim();
        
        if (afterWakeWord.length > 0 && finalTranscript.length > 0) {
          executeCommand(word, afterWakeWord);
        } else {
          startCommandWindow(word);
        }
        break;
      }
    }
  };
  
  recognition.onerror = (e) => {
    console.error('Speech error:', e.error);
    if (e.error === 'not-allowed') {
      updateVoiceStatus('Microphone blocked');
      stopHotword();
    } else if (hotwordEnabled) {
      setTimeout(() => {
        if (hotwordEnabled && !isListening) {
          try { recognition.start(); } catch(err) {}
        }
      }, 500);
    }
  };
  
  recognition.onend = () => {
    console.log('Recognition ended - auto-restarting...');
    isListening = false;
    
    if (hotwordEnabled) {
      setTimeout(() => {
        if (hotwordEnabled && !isListening) {
          try {
            recognition.start();
            console.log('Auto-restarted successfully');
          } catch (err) {
            console.error('Auto-restart failed:', err);
            setTimeout(() => {
              if (hotwordEnabled && !isListening) {
                try { recognition.start(); } catch(e) {}
              }
            }, 1000);
          }
        }
      }, 100);
    } else {
      cleanupVoiceState();
    }
  };
}

function startCommandWindow(wakeWord) {
  isWaitingForCommand = true;
  let timeLeft = COMMAND_TIMEOUT_MS / 1000;
  
  elements.voiceStatus.classList.remove('hotword-mode');
  elements.voiceStatus.classList.add('recording-mode');
  elements.voiceDot.classList.add('recording');
  elements.voiceBtn.classList.add('recording');
  updateVoiceStatus(`"${wakeWord}" detected! Speak now`);
  elements.countdown.textContent = `${timeLeft}s`;
  
  console.log(`Wake word "${wakeWord}" detected, waiting ${COMMAND_TIMEOUT_MS}ms for command...`);
  
  if (commandTimeout) clearTimeout(commandTimeout);
  if (countdownInterval) clearInterval(countdownInterval);
  
  countdownInterval = setInterval(() => {
    timeLeft--;
    elements.countdown.textContent = `${timeLeft}s`;
    
    if (timeLeft <= 0) {
      clearInterval(countdownInterval);
      elements.countdown.textContent = '';
    }
  }, 1000);
  
  commandTimeout = setTimeout(() => {
    if (isWaitingForCommand) {
      console.log('Command window timeout');
      isWaitingForCommand = false;
      clearInterval(countdownInterval);
      elements.countdown.textContent = '';
      updateVoiceStatus('Timeout. Ready for next command...');
      elements.voiceStatus.classList.add('hotword-mode');
      elements.voiceStatus.classList.remove('recording-mode');
      elements.voiceDot.classList.remove('recording');
      elements.voiceBtn.classList.remove('recording');
    }
  }, COMMAND_TIMEOUT_MS);
}

function handleCommandInput(fullTranscript, finalTranscript) {
  if (finalTranscript.trim().length > 0) {
    const commandText = finalTranscript.trim();
    console.log('Command received:', commandText);
    
    if (commandTimeout) clearTimeout(commandTimeout);
    if (countdownInterval) clearInterval(countdownInterval);
    elements.countdown.textContent = '';
    isWaitingForCommand = false;
    
    let detectedWakeWord = 'search';
    for (const word of WAKE_WORDS) {
      if (fullTranscript.includes(word)) {
        detectedWakeWord = word;
        const index = fullTranscript.indexOf(word);
        const afterWord = fullTranscript.substring(index + word.length).trim();
        if (afterWord.length > 0) {
          executeCommand(word, afterWord);
          return;
        }
        break;
      }
    }
    
    executeCommand(detectedWakeWord, commandText);
  }
}

function executeCommand(wakeWord, commandText) {
  console.log(`Executing: ${wakeWord} - ${commandText}`);
  
  if (commandTimeout) clearTimeout(commandTimeout);
  if (countdownInterval) clearInterval(countdownInterval);
  isWaitingForCommand = false;
  elements.countdown.textContent = '';
  
  elements.voiceStatus.classList.add('hotword-mode');
  elements.voiceStatus.classList.remove('recording-mode');
  elements.voiceDot.classList.remove('recording');
  elements.voiceBtn.classList.remove('recording');
  
  switch(wakeWord) {
    case 'clear':
      clearSearch();
      updateVoiceStatus('Search cleared! Ready...');
      setTimeout(() => {
        if (hotwordEnabled) updateVoiceStatus('Always listening...');
      }, 2000);
      break;
      
    case 'search':
    case 'hope':
      if (commandText) {
        elements.input.value = commandText;
        toggleClearButton();
        handleSearch(commandText);
        updateVoiceStatus(`Searching: ${commandText}`);
      } else {
        elements.input.focus();
        updateVoiceStatus('What should I search?');
      }
      setTimeout(() => {
        if (hotwordEnabled) updateVoiceStatus('Always listening...');
      }, 3000);
      break;
      
    case 'open':
      if (commandText) {
        const site = commandText.replace(/\s+/g, '').toLowerCase();
        window.open(`https://${site}.com`, '_blank');
        showMessage(`Opening ${site}.com...`);
        updateVoiceStatus(`Opened ${site}.com`);
        elements.input.value = `open ${commandText}`;
        toggleClearButton();
      } else {
        updateVoiceStatus('What site should I open?');
      }
      setTimeout(() => {
        if (hotwordEnabled) updateVoiceStatus('Always listening...');
      }, 3000);
      break;
      
    case 'play':
      if (commandText) {
        const musicQuery = `play ${commandText}`;
        elements.input.value = musicQuery;
        toggleClearButton();
        handleMusicQuery(musicQuery);
        updateVoiceStatus(`Playing: ${commandText}`);
      } else {
        updateVoiceStatus('What should I play?');
      }
      setTimeout(() => {
        if (hotwordEnabled) updateVoiceStatus('Always listening...');
      }, 3000);
      break;
  }
}

function cleanupVoiceState() {
  isListening = false;
  isWaitingForCommand = false;
  if (commandTimeout) clearTimeout(commandTimeout);
  if (countdownInterval) clearInterval(countdownInterval);
  elements.countdown.textContent = '';
  elements.voiceStatus.style.display = 'none';
  elements.voiceBtn.classList.remove('hotword-active', 'recording');
  elements.voiceStatus.classList.remove('hotword-mode', 'recording-mode');
  elements.voiceDot.classList.remove('recording');
}

function toggleHotwordMode() {
  if (!recognition) {
    alert('Voice recognition not supported');
    return;
  }
  
  if (hotwordEnabled) {
    stopHotword();
    hotwordEnabled = false;
    elements.welcomeHint.innerHTML = 'Click üé§ to activate voice ‚Ä¢ Always listening when ON<br><small style="opacity:0.7">Say: "Search...", "Open...", "Play...", or "Clear" ‚Ä¢ You have 10 seconds after wake word</small>';
  } else {
    hotwordEnabled = true;
    try {
      recognition.start();
      elements.welcomeHint.innerHTML = '<b style="color:var(--hotword)">Voice ACTIVE!</b> Always listening ‚Ä¢ Click üé§ again to stop';
    } catch (e) {
      console.error('Start failed:', e);
      hotwordEnabled = false;
    }
  }
}

function stopHotword() {
  hotwordEnabled = false;
  if (recognition) {
    try { recognition.stop(); } catch (e) {}
  }
  cleanupVoiceState();
}

function updateVoiceStatus(text) {
  elements.voiceText.innerText = text;
}

/* ========== LOCAL AI SUMMARY ========== */
function generateAISummary(query, items) {
  if (!items || items.length === 0) return '';
  const text = items.map(i => i.snippet).join(' ');
  const sentences = text.match(/[^\.!\?]+[\.!\?]+/g) || [];
  const important = sentences.filter(s => s.length > 60).slice(0, 5);
  
  return `
    <div class="result-card" style="border-left:3px solid var(--accent)">
      <div class="dogu-ai-header">
        <div class="dogu-ai-icon">‚ú®</div>
        <b>Quick Summary</b>
      </div>
      <div class="result-snippet">
        ${important.map(s => `‚Ä¢ ${s.trim()}`).join('<br>')}
      </div>
      <div class="note" style="color:var(--muted);font-size:.8rem;margin-top:12px">
        Generated from top web sources
      </div>
    </div>
  `;
}

/* ========== SEARCH FUNCTIONS ========== */
async function handleSearch(query) {
  const q = query.trim();
  if (!q) {
    elements.input.focus();
    return;
  }
  
  elements.header.classList.add('top-mode');
  elements.tabs.classList.add('visible');
  elements.welcomeHint.style.display = 'none';
  
  addToHistory(q);
  toggleClearButton();
  
  if (q.toLowerCase().startsWith('play ')) {
    handleMusicQuery(q);
    return;
  }
  
  if (q.toLowerCase().startsWith('open ')) {
    const site = q.replace(/^open\s+/i, '').replace(/\s+/g, '');
    window.open(`https://${site}.com`, '_blank');
    showMessage(`Opening ${site}.com...`);
    return;
  }
  
  if (q.toLowerCase().includes('gmail')) {
    window.open('https://mail.google.com', '_blank');
    showMessage('Opening Gmail...');
    return;
  }
  
  yakinSearch(q, currentTab, 1);
}

async function yakinSearch(query, type = 'web', page = 1) {
  lastQuery = query;
  currentPage = page;
  currentTab = type;
  elements.results.innerHTML = '<div class="loading-spinner"></div>';
  window.scrollTo({top:0, behavior:'smooth'});
  
  if (!CONFIG.GOOGLE_API_KEY || !CONFIG.GOOGLE_CX) {
    showError('Please configure Google API Key and CX in the code.');
    return;
  }
  
  const start = (page - 1) * 10 + 1;
  const url = `https://www.googleapis.com/customsearch/v1?q=${encodeURIComponent(query)}&key=${CONFIG.GOOGLE_API_KEY}&cx=${CONFIG.GOOGLE_CX}&start=${start}&num=10`;
  
  try {
    const res = await fetch(url);
    const data = await res.json();
    
    if (data.error) {
      showError(`API Error: ${data.error.message}`);
      return;
    }
    displayResults(data.items || [], query, page);
  } catch (e) {
    showError('Search failed. Check your connection.');
  }
}

function displayResults(items, query, page) {
  if (items.length === 0) {
    elements.results.innerHTML = `
      <div class="result-card" style="text-align:center;padding:40px">
        <div style="font-size:3rem;margin-bottom:12px">üîç</div>
        <h3>No results found for "${escapeHtml(query)}"</h3>
      </div>`;
    return;
  }
  
  let html = generateAISummary(query, items);
  
  items.forEach(item => {
    try {
      const url = new URL(item.link);
      const domain = url.hostname;
      html += `
        <div class="result-card">
          <a class="result-title" href="${item.link}" target="_blank" rel="noopener">${item.title}</a>
          <div class="result-url">
            <img class="result-favicon" src="https://www.google.com/s2/favicons?domain=${domain}&sz=32" alt="" width="16" height="16">
            ${domain}
          </div>
          <div class="result-snippet">${item.snippet || ''}</div>
        </div>`;
    } catch (e) {}
  });
  
  html += `
    <div class="pagination">
      <button class="page-btn" onclick="yakinSearch('${escapeHtml(query)}','${currentTab}',${page-1})" ${page===1?'disabled':''}>‚Äπ Previous</button>
      <span style="color:var(--muted);font-size:0.9rem">Page ${page}</span>
      <button class="page-btn" onclick="yakinSearch('${escapeHtml(query)}','${currentTab}',${page+1})">Next ‚Ä∫</button>
    </div>`;
  
  elements.results.innerHTML = html;
}

function handleMusicQuery(query) {
  const musicData = parseMusicQuery(query);
  
  elements.results.innerHTML = `
    <div class="result-card">
      <div class="dogu-ai-header">
        <div class="dogu-ai-icon">üéµ</div>
        <b>Playing: ${escapeHtml(musicData.fullQuery)}</b>
      </div>
      ${musicData.artist ? `<p style="color:var(--muted);margin-bottom:16px">Artist: ${escapeHtml(musicData.artist)}</p>` : ''}
      <div class="music-options">
        <button class="music-btn" onclick="playYouTube('${escapeHtml(musicData.fullQuery)}')">‚ñ∂Ô∏è YouTube</button>
        <button class="music-btn" onclick="playSpotify('${escapeHtml(musicData.fullQuery)}')">üéß Spotify</button>
        <button class="music-btn" onclick="playYouTubeMusic('${escapeHtml(musicData.fullQuery)}')">üéµ YT Music</button>
      </div>
      <div id="embedBox"></div>
    </div>`;
  
  if (CONFIG.YOUTUBE_API_KEY) {
    setTimeout(() => playYouTube(musicData.fullQuery), 800);
  }
}

function parseMusicQuery(query) {
  const patterns = [
    /play\s+"(.+?)"\s+by\s+(.+)/i,
    /play\s+(.+?)\s+by\s+(.+)/i,
    /play\s+(.+)/i
  ];
  
  for (const pattern of patterns) {
    const match = query.match(pattern);
    if (match) {
      return {
        song: match[1].trim(),
        artist: match[2] ? match[2].trim() : '',
        fullQuery: match[2] ? `${match[1].trim()} ${match[2].trim()}` : match[1].trim()
      };
    }
  }
  return { song: query.replace(/^play\s+/i, '').trim(), artist: '', fullQuery: query.replace(/^play\s+/i, '').trim() };
}

async function playYouTube(query) {
  if (!CONFIG.YOUTUBE_API_KEY) {
    window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`, '_blank');
    return;
  }
  try {
    const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(query)}&key=${CONFIG.YOUTUBE_API_KEY}&maxResults=1`);
    const data = await res.json();
    if (data.items?.[0]) {
      const embed = document.getElementById('embedBox');
      if (embed) {
        embed.innerHTML = `<iframe src="https://www.youtube.com/embed/${data.items[0].id.videoId}?autoplay=1" width="100%" height="360" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
      }
    }
  } catch (e) {
    console.error('YouTube error:', e);
  }
}

function playSpotify(query) {
  window.open(`https://open.spotify.com/search/${encodeURIComponent(query)}`, '_blank');
}

function playYouTubeMusic(query) {
  window.open(`https://music.youtube.com/search?q=${encodeURIComponent(query)}`, '_blank');
}

/* ========== FILE HANDLING ========== */
function openFileModal() {
  elements.fileModal.style.display = 'flex';
  renderFileList();
}

function closeFileModal() {
  elements.fileModal.style.display = 'none';
}

function handleFileDrop(e) {
  e.preventDefault();
  elements.uploadArea.classList.remove('dragover');
  processFiles(Array.from(e.dataTransfer.files));
}

function handleFileSelect(e) {
  processFiles(Array.from(e.target.files));
  e.target.value = '';
}

function processFiles(files) {
  files.forEach(file => {
    uploadedFiles.unshift({
      name: file.name,
      size: file.size,
      type: file.type,
      lastModified: file.lastModified,
      preview: URL.createObjectURL(file),
      id: Date.now().toString(36) + Math.random().toString(36).substr(2)
    });
    if (uploadedFiles.length > 10) uploadedFiles.pop();
  });
  
  localStorage.setItem('yakinFiles', JSON.stringify(uploadedFiles));
  renderFileList();
  showMessage(`üìÅ Uploaded ${files.length} file(s) successfully`);
}

function renderFileList() {
  if (uploadedFiles.length === 0) {
    elements.fileList.innerHTML = '<p class="note" style="text-align:center;padding:20px">No files uploaded yet</p>';
    return;
  }
  
  elements.fileList.innerHTML = uploadedFiles.slice(0, 5).map(file => `
    <div class="file-item">
      <span class="file-name">üìÑ ${escapeHtml(file.name)}</span>
      <span class="file-size">${formatFileSize(file.size)}</span>
      <button class="file-action-btn" onclick="window.open('${file.preview}', '_blank')" title="View">üëÅÔ∏è</button>
      <button class="file-action-btn" onclick="removeFile('${file.id}')" title="Delete">üóëÔ∏è</button>
    </div>
  `).join('');
}

function removeFile(id) {
  uploadedFiles = uploadedFiles.filter(f => f.id !== id);
  localStorage.setItem('yakinFiles', JSON.stringify(uploadedFiles));
  renderFileList();
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function searchOnService(service) {
  const query = elements.input.value.trim();
  const prefixes = {
    googleDrive: 'site:drive.google.com',
    dropbox: 'site:dropbox.com',
    onedrive: 'site:onedrive.live.com',
    icloud: 'site:icloud.com'
  };
  
  if (query && prefixes[service]) {
    yakinSearch(`${prefixes[service]} ${query}`, 'web', 1);
  } else {
    openService(service);
  }
  closeFileModal();
}

function openService(service) {
  const urls = {
    wetransfer: 'https://wetransfer.com',
    github: 'https://github.com',
    figma: 'https://figma.com',
    notion: 'https://notion.so',
    googledrive: 'https://drive.google.com',
    dropbox: 'https://dropbox.com',
    onedrive: 'https://onedrive.live.com',
    icloud: 'https://icloud.com'
  };
  window.open(urls[service] || `https://${service}.com`, '_blank');
  closeFileModal();
}

/* ========== UTILITIES ========== */
function addToHistory(q) {
  if (!q) return;
  searchHistory = searchHistory.filter(item => item.toLowerCase() !== q.toLowerCase());
  searchHistory.unshift(q);
  searchHistory = searchHistory.slice(0, 10);
  localStorage.setItem('yakinHistory', JSON.stringify(searchHistory));
}

function renderHistory() {
  if (searchHistory.length === 0 && uploadedFiles.length === 0) return;
  
  let html = '<div style="max-width:584px;margin:0 auto;padding:0 24px">';
  
  if (uploadedFiles.length > 0) {
    html += `
      <div style="margin-bottom:24px">
        <div style="color:var(--muted);font-size:0.85rem;margin-bottom:12px;font-weight:600">RECENT FILES</div>
        ${uploadedFiles.slice(0, 3).map(f => `
          <div class="file-item" style="cursor:pointer" onclick="window.open('${f.preview}', '_blank')">
            <span class="file-name">üìÑ ${escapeHtml(f.name)}</span>
            <span class="file-size">${formatFileSize(f.size)}</span>
          </div>`).join('')}
      </div>`;
  }
  
  if (searchHistory.length > 0) {
    html += `
      <div>
        <div style="color:var(--muted);font-size:0.85rem;margin-bottom:12px;font-weight:600">RECENT SEARCHES</div>
        ${searchHistory.map(item => `
          <div class="history-item" onclick="elements.input.value='${escapeHtml(item)}'; handleSearch('${escapeHtml(item)}')">
            ${escapeHtml(item)}
          </div>`).join('')}
      </div>`;
  }
  
  html += '</div>';
  elements.results.innerHTML = html;
}

function switchTab(type) {
  currentTab = type;
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.toggle('active', t.dataset.type === type);
  });
  if (lastQuery) yakinSearch(lastQuery, type, 1);
}

function handleInputKeydown(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    handleSearch(elements.input.value);
  } else if (e.key === '/' && document.activeElement !== elements.input) {
    e.preventDefault();
    elements.input.focus();
  } else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
    e.preventDefault();
    openFileModal();
  } else if (e.key === 'Escape') {
    if (isListening && hotwordEnabled) {
      stopHotword();
    } else if (elements.fileModal.style.display === 'flex') {
      closeFileModal();
    } else {
      elements.input.blur();
    }
  }
}

function showMessage(msg) {
  elements.results.innerHTML = `<div class="result-card" style="text-align:center">${escapeHtml(msg)}</div>`;
}

function showError(msg) {
  elements.results.innerHTML = `<div class="result-card" style="border-left:3px solid #ef4444;color:#fecaca">${escapeHtml(msg)}</div>`;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/* ========== START APPLICATION ========== */
init();
</script>
</body>
</html>
